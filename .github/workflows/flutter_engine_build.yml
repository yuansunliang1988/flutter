name: Build Flutter Windows Engine

on:
  push:
    branches:
      - master  # 触发构建的分支
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest  # 使用 GitHub 提供的 Windows 环境

    steps:
      # 1. 检出代码
      - name: Checkout Flutter
        uses: actions/checkout@v4
        with:
          submodules: true  # 确保子模块也被拉取

      # 2. 安装 Python 3.x（如果未预装）
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 3. 缓存 depot_tools
      - name: Cache depot_tools
        id: cache-depot_tools
        uses: actions/cache@v4
        with:
          path: depot_tools
          key: depot_tools-${{ runner.os }}

      # 4. 安装 depot_tools（Flutter 构建依赖）
      - name: Install depot_tools
        if: steps.cache-depot_tools.outputs.cache-hit != 'true'
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        env:
          DEPOT_TOOLS_PATH: ${{ github.workspace }}/depot_tools

      # 5. 设置 depot_tools PATH
      - name: Setup depot_tools PATH
        run: |
          echo "${{ github.workspace }}/depot_tools" >> $env:GITHUB_PATH

      # 6. 缓存 Flutter engine
      - name: Cache Flutter engine
        id: cache-flutter-engine
        uses: actions/cache@v4
        with:
          path: engine
          key: flutter-engine-${{ runner.os }}-${{ hashFiles('**/DEPS') }}

      # 7. 使用 GitHub Actions 预装的 Visual Studio（推荐）
      - name: Setup Visual Studio
        uses: microsoft/setup-msbuild@v1.1

      # 8. 安装 Dart SDK
      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      # 9. 安装 Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 10. 配置 Git 全局设置
      - name: Configure Git
        run: |
          git config --global core.autocrlf false
          git config --global core.filemode false
          git config --global core.fscache true
          git config --global core.preloadindex true

      # 11. 同步 Flutter 引擎代码
      - name: Sync Flutter Engine
        if: steps.cache-flutter-engine.outputs.cache-hit != 'true'
        run: |
          cd engine
          gclient config https://github.com/flutter/flutter.git
          gclient sync --nohooks

      # 12. 检查目录结构
      - name: Check directory structure
        run: |
          cd engine
          ls -la
          if (Test-Path "buildtools") { ls -la buildtools }
          if (Test-Path "buildtools\win") { ls -la buildtools\win }

      # 13. 生成构建配置（GN）
      - name: Generate GN Build Files
        run: |
          cd engine
          if (Test-Path "buildtools\win\gn.exe") {
            .\buildtools\win\gn.exe gen out\host_release --args="target_cpu=\"x64\" is_debug=false is_official_build=true is_component_build=false enable_impeller=true"
          } else {
            Write-Host "gn.exe not found in buildtools\win\"
            Write-Host "Trying to find gn.exe..."
            Get-ChildItem -Recurse -Name "gn.exe" | Select-Object -First 5
            exit 1
          }

      # 14. 编译 Flutter Windows 引擎
      - name: Build Flutter Windows Engine
        run: |
          cd engine
          if (Test-Path "buildtools\win\ninja.exe") {
            .\buildtools\win\ninja.exe -C out\host_release
          } else {
            Write-Host "ninja.exe not found in buildtools\win\"
            Write-Host "Trying to find ninja.exe..."
            Get-ChildItem -Recurse -Name "ninja.exe" | Select-Object -First 5
            exit 1
          }

      # 15. 上传构建产物（flutter_engine.dll, lib, pdb）
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter_engine_windows_release
          path: |
            engine/out/host_release/flutter_engine.dll
            engine/out/host_release/flutter_engine.lib
            engine/out/host_release/flutter_engine.pdb